<!DOCTYPE html>

<html lang='en'>
<head>
  <meta charset="utf-8">
  <title>
    PSET6-2
  </title>
  <script src = "https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <!-- Exercise 6.2: Produce a choropleth map

  Task 6.2.1: Make a choropleth map
  In the next part of this problem set, you will produce a choropleth map of Boston Neighborhoods, which are shaded according to the number of 311 requests that are made using Twitter.
  You'll need to use
  the boston.json TopoJSON file https://gist.githubusercontent.com/cesandoval/09b2e39263c748fbcb84b927cecc7c46/raw/ab71d3638efd2545ec99c2651c6f2ddcea9d2a07/boston.json
  and the boston_311_totals.csv file (New link https://raw.githubusercontent.com/brookefzy/BigData2020/master/pset6/boston_311.csv).

  Your map should:
  ●	Use d3.schemePurples[9] from d3-scale-quantize() to set colors.
  ●	Be projected using d3.geoAlbers().
  ●	Use a logarithm function to transform the number of 311 Twitter requests
  Hint: the logarithm scale is a nonlinear scale used to respond to skewness towards large values; i.e., cases in which one or a few points are much larger than the bulk of the data.
  You can apply a logarithm transformation for the value with this function:
  Math.log() -->
  <style>
  .counties {
    fill: none;
  }

  .states {
    fill: none;
    stroke: #fff;
    stroke-linejoin: round;
  }
  </style>
</head>

<body>
  <script>
  // var uscountyurl='https://unpkg.com/us-atlas@1/us/10m.json'
  // var unemploymenturl ="https://gist.githubusercontent.com/jdev42092/9a314291805640a097e16e58248627eb/raw/365c199c5a173a0018608615b6823b5cdcaa6bae/unemployment.tsv"

  var bostonurl = 'https://gist.githubusercontent.com/cesandoval/09b2e39263c748fbcb84b927cecc7c46/raw/ab71d3638efd2545ec99c2651c6f2ddcea9d2a07/boston.json'
  var boston311url = 'https://raw.githubusercontent.com/brookefzy/BigData2020/master/pset6/boston_311.csv'

  // var bosNeighborurl="https://gist.githubusercontent.com/jdev42092/5c285c4a3608eb9f9864f5da27db4e49/raw/a1c33b1432ca2948f14f656cc14c7c7335f78d95/boston_neighborhoods.json"

  var width = 1000,
  height = 600;

  // var path = d3.geoPath()
  var geoPath = d3.geoPath()
                  .projection(albersProjection)

  var svg = d3.select("body")
  .append("svg")
  .attr("width", width)
  .attr("height", height);

  var x = d3.scaleLinear()
  .domain([1, 10])
  .rangeRound([600, 860]);

  var color = d3.scaleQuantize()
  .domain(d3.range(2, 10))
  .range(d3.schemePurples[9]);

  // var g = svg.append("g")
  var g = svg.append("g")
            .attr("class", "key")
            .attr("transform", "translate(0,40)");

  var albersProjection = d3.geoAlbers()
  .scale( 190000)
  .rotate([71.057,0])
  .center([0,42.313])
  .translate([width/2, height/2])

  // var unemployment = d3.map();

  var boston = d3.map();





  g.selectAll("rect")
  .data(color.range().map(function(d) {
    d = color.invertExtent(d);
    if (d[0] == null) d[0] = x.domain()[0];
    if (d[1] == null) d[1] = x.domain()[1];
    return d;
  }))
  .enter().append("rect")
  .attr("height", 8)
  .attr("x", function(d) { return x(d[0]); })
  .attr("width", function(d) { return x(d[1]) - x(d[0]); })
  .attr("fill", function(d) { return color(d[0]); });

  g.append("text")
  .attr("class", "caption")
  .attr("x", x.range()[0])
  .attr("y", -6)
  .attr("fill", "#000")
  .attr("text-anchor", "start")
  .attr("font-weight", "bold")
  .text("Unemployment rate");

  g.call(d3.axisBottom(x)
  .tickSize(13)
  .tickFormat(function(x, i) { return i ? x : x + "%"; })
  .tickValues(color.domain()))
  .select(".domain")
  .remove();

  // var promises = [
  //   // d3.json(uscountyurl),
  //   // d3.tsv(unemploymenturl,
  //   d3.json(bostonurl),
  //   d3.csv(boston311url,
  //     function(d) { unemployment.set(d.id, +d.rate); })
  //   ]

    // Promise.all(promises).then(ready)

    d3.json(bostonurl).then(function(bosMap){
     console.log(bosMap)
           g.selectAll("path")
            .data(bosMap[0])
            .enter()
            .append("path")
            .attr("fill","#ccc")
            .attr("stroke","#333")
            .attr("d",geoPath)
    })

    //     d3.json(bosNeighborurl).then(function(bosNeighbor){
    //       console.log(bosNeighbor)
    //       g.selectAll("path")
    //       .data(bosNeighbor.features)
    //       .enter()
    //       .append("path")
    //       .attr("fill","#ccc")
    //       .attr("stroke","#333")
    //       .attr("d",geoPath)
    // })

    // function ready([us]) {
    //   console.log(us)
    //   console.log(unemployment)
    //   svg.append("g")
    //   .attr("class", "counties")
    //   .selectAll("path")
    //   .data(topojson.feature(us, us.objects.counties).features)
    //   .enter().append("path")
    //   .attr("fill", function(d) { return color(d.rate = unemployment.get(d.id)); })
    //   .attr("d", path)
    //   .append("title")
    //   .text(function(d) { return d.rate + "%"; });
    //
    //   svg.append("path")
    //   .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
    //   .attr("class", "states")
    //   .attr("d", path);
    // }

    // Task 6.2.2: Add a tooltip
    // Now we'll want to add some user interaction. We will add the specific percentage of Twitter reporting associated with a given neighborhood. Let's add a tooltip that will display the name of the neighborhood and its percentage when a user mouses over its geometry!
    // Your tooltip should:
    // ●	Have a white background color.
    // ●	Have 5 pixels of padding around the text.
    // ●	Be 60% opaque. All three of these properties should be set using .style() methods!



    // Task 6.2.2: Add a legend
    // We will add a legend to allow the user to reference the shading of the neighborhoods. Create a legend in D3, in a similar way of other D3 graphics. You will be drawing rectangles that will be shaded like the geometries and an axis that displays the range to which each rectangle corresponds. Hints: this example can be a useful reference. To make the legend visible you might have to experiment with the legend's width, and your map's height. Also make sure that your variables are scoped correctly.


    </script>
  </body>
  </html>
